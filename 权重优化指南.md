# 📊 权重优化完整指南

## 🎯 目标

通过1-2个月的实盘数据，分析各指标与T+1收益的关系，优化评分模型权重。

---

## 📅 时间线

```
Day 1-60：数据收集期（1-2个月）
  ├─ 每天运行collect_backtest_data.py
  ├─ 记录Top30股票的所有指标
  └─ 第二天更新T+1收益

Day 61：数据分析
  ├─ 运行optimize_weights.py
  ├─ 查看分析报告
  └─ 决定是否调整权重

Day 62+：应用新权重
  ├─ 修改quant_analysis.py中的权重
  ├─ 继续收集数据
  └─ 3个月后再次评估
```

---

## 🔧 详细步骤

### 第1步：每日数据收集（开市时间）

```bash
# 进入项目目录
cd /Users/mico/github/tick_analysis

# 激活虚拟环境
source venv/bin/activate

# 运行数据收集（推荐用选项4）
python3 collect_backtest_data.py
# 选择：4（全部执行）

# 这会做3件事：
# 1. 更新昨天的T+1收益
# 2. 收集今天的数据
# 3. 导出到CSV
```

**时间安排：**
- 最佳时间：14:30-14:50（尾盘）
- 每天只需运行1次
- 耗时：约1-2分钟

**注意事项：**
- ⚠️ 周末和节假日不运行
- ⚠️ 确保有网络连接
- ⚠️ 不要删除backtest_data.json和backtest_data.csv

---

### 第2步：查看数据积累情况

```bash
# 查看CSV文件
cat backtest_data.csv | wc -l
# 输出：行数（记录数+1）

# 查看最新数据
tail -n 5 backtest_data.csv

# 或用Excel/Numbers打开
open backtest_data.csv
```

**数据量要求：**
- ✅ 最少：30条有效记录（约2周）
- ✅ 推荐：100条有效记录（约1个月）
- ✅ 最佳：300条有效记录（约2个月）

---

### 第3步：数据分析（1-2个月后）

```bash
# 运行权重优化脚本
python3 optimize_weights.py
```

**会输出4个分析：**

#### 分析1：相关性分析

```
指标                          相关系数      强度
--------------------------------------------------
relative_net_buy              0.325    ⭐⭐⭐ 强
closing_ratio                 0.287    ⭐⭐⭐ 强
momentum_acceleration         0.215    ⭐⭐ 中
excess_return                 0.183    ⭐⭐ 中
pressure_ratio                0.142    ⭐ 弱
...
```

**解读：**
- 相关系数 > 0.2 → 重要指标，应保持高权重
- 相关系数 < 0.05 → 作用不大，可降低权重

---

#### 分析2：特征重要性

```
指标                          重要性      星级
--------------------------------------------------
relative_net_buy              0.185    ⭐⭐⭐ 高
closing_ratio                 0.142    ⭐⭐ 中
momentum_ratio                0.098    ⭐⭐ 中
...
```

**解读：**
- 重要性 > 0.1 → 核心指标
- 重要性 < 0.03 → 边缘指标

---

#### 分析3：评分区间分析

```
区间      数量  平均T+1收益      标准差         建议
------------------------------------------------------------
<0        12      -0.83%      2.15%     ❌ 回避
0-30      45       0.32%      1.89%     ⚠️ 轻仓
30-50     82       1.15%      2.34%     ⚠️ 轻仓
50-70     96       2.08%      2.67%     ✅ 中仓
70-90     58       3.42%      3.12%     ✅ 重仓
90+       15       4.21%      3.85%     ✅ 重仓
```

**解读：**
- 如果70分以上平均收益 > 3% → 策略有效
- 如果50-70分收益最高 → 可能需要降低买入阈值
- 如果各区间收益差不多 → 评分模型需要大改

---

#### 分析4：权重优化建议

```
指标                          当前权重    建议权重      变化
-----------------------------------------------------------------
relative_net_buy                175.0       180.0    +5.0分
closing_ratio                    20.0        25.0    +5.0分 ⚠️
pressure_ratio                   20.0        12.0    -8.0分 ⚠️
...
```

**解读：**
- 变化 < ±10% → 可以不调整
- 变化 > ±20% → 建议调整

---

### 第4步：决定是否调整权重

#### 场景A：模型表现良好

**判断标准：**
- ✅ 评分70+的股票，平均T+1收益 > 2%
- ✅ 评分70+的胜率 > 60%
- ✅ R²评分 > 0.3

**建议：** 保持当前权重，继续收集数据

---

#### 场景B：需要微调

**判断标准：**
- 某些指标权重明显偏高/偏低（变化>20%）
- 但整体表现还可以

**操作：** 调整2-3个权重最离谱的指标

示例修改（在quant_analysis.py中）：

```python
# 第915行附近
# 调整前
net_buy_score = np.clip(relative_net_buy * 175, -35, 35)

# 调整后（如果建议权重是180）
net_buy_score = np.clip(relative_net_buy * 180, -35, 35)
```

---

#### 场景C：需要大改

**判断标准：**
- ❌ 评分高的股票反而收益低
- ❌ R²评分 < 0.1
- ❌ 各评分区间收益差不多

**建议：**
1. 检查数据质量（是否有异常值）
2. 考虑市场环境（牛市/熊市不同）
3. 可能需要重新设计评分模型

---

### 第5步：应用新权重

#### 5.1 备份当前代码

```bash
cp quant_analysis.py quant_analysis_v8.4_backup.py
```

#### 5.2 修改权重

找到 `_calculate_score_v8` 方法（约第910-985行），修改对应权重：

```python
# 示例：调整相对净买入权重
# 从175改为180
net_buy_score = np.clip(relative_net_buy * 180, -35, 35)

# 示例：调整尾盘动量权重
# 从20改为25
if closing_ratio > 0.2:
    closing_score = 25 * min((closing_ratio - 0.2) / 0.3, 1.0)
```

#### 5.3 更新版本号

```python
# 第57行和其他地方
"V8.4-Intraday" → "V8.5-Optimized"
```

#### 5.4 测试新权重

```bash
# 测试初始化
python3 -c "from quant_analysis import QuantAnalysis; qa = QuantAnalysis()"

# 如果成功，运行一次测试
./run.sh test
```

---

## 📊 权重调整原则

### 1. 保守原则

```
小幅调整：每次不超过±20%
逐步优化：调整2-3个指标即可
持续验证：调整后继续收集1个月数据
```

### 2. 数据驱动

```
✅ 基于至少100条有效数据
✅ 相关性和重要性都要看
✅ 评分区间分析要合理
❌ 不要只看单一指标
```

### 3. 避免过拟合

```
⚠️ 不要完全按照建议权重
⚠️ 保留一定的经验判断
⚠️ 定期重新评估（每季度）
```

---

## 🎯 实际案例

### 案例1：权重合理，无需调整

**数据：**
- 收集了60天数据，共180条记录
- 评分70+的股票平均T+1收益 3.2%
- R²评分 0.42

**分析结果：**
- 所有指标权重建议变化 < 15%
- 评分区间收益递增

**决策：** 保持当前权重，继续使用

---

### 案例2：微调优化

**数据：**
- 收集了45天数据，共135条记录
- 评分70+的股票平均T+1收益 2.1%
- R²评分 0.35

**分析结果：**
- `closing_ratio` 相关性0.35，建议权重从20提到28
- `pressure_ratio` 相关性0.08，建议权重从20降到12
- 其他指标变化不大

**决策：** 调整这2个权重，升级到V8.5

```python
# 调整1：提升尾盘权重
closing_score = 28 * min((closing_ratio - 0.2) / 0.3, 1.0)  # 从20改为28

# 调整2：降低压力比权重
if pressure_ratio > 1.2:
    pressure_score = min((pressure_ratio - 1.2) * 15, 15)  # 从20改为15
```

---

### 案例3：需要重新评估

**数据：**
- 收集了30天数据，共90条记录
- 评分70+的股票平均T+1收益 0.8%
- 评分30-50的股票平均T+1收益 1.2%
- R²评分 0.12

**分析结果：**
- 评分高的反而收益低
- 各指标相关性都很低

**问题诊断：**
1. 样本量可能不够（建议收集到150+）
2. 市场环境特殊（熊市/震荡市）
3. 数据质量问题（人工检查异常值）

**决策：** 暂不调整，继续收集2个月数据

---

## 📝 检查清单

### 收集数据阶段（每日）

- [ ] 每天14:30-14:50运行数据收集脚本
- [ ] 检查backtest_data.csv行数增长
- [ ] 确保T+1收益有更新
- [ ] 备份数据文件（每周）

### 分析阶段（1-2个月后）

- [ ] 有效数据 ≥ 100条
- [ ] 运行权重优化脚本
- [ ] 查看4个分析报告
- [ ] 对比当前权重和建议权重
- [ ] 评估是否需要调整

### 调整权重阶段

- [ ] 备份当前代码
- [ ] 修改权重（保守调整）
- [ ] 更新版本号
- [ ] 测试运行
- [ ] 继续收集1个月数据验证

---

## ⚠️ 常见问题

### Q1: 数据收集了1个月，但只有50条有效记录？

**原因：** 部分股票第二天不在Top30，所以没有T+1价格

**解决：** 正常现象，继续收集到100条以上

---

### Q2: 分析结果显示R²很低（<0.1）？

**可能原因：**
1. 样本量太少
2. 市场环境特殊
3. 评分模型本身问题

**建议：** 继续收集数据，如果样本量>200还是很低，考虑重新设计模型

---

### Q3: 不同市场环境下权重应该不同吗？

**是的！** 但建议先用统一权重，除非：
- 明确识别出牛市/熊市
- 有足够多的牛市和熊市数据分别分析

---

## 🎯 总结

```
1. 数据收集：每天1次，持续1-2个月
2. 数据分析：运行优化脚本，查看4个分析
3. 权重调整：保守调整2-3个指标
4. 持续验证：调整后再收集1个月验证
5. 定期评估：每季度重新分析一次
```

**记住：量化交易是一个持续优化的过程！** 📈

---

**祝你交易顺利！** 🎉
