# Tick Analysis 量化分析系统

基于AKShare的智能股票分析系统，能够识别主力拆单行为并预测股票走势。

## 🎯 系统概述

本系统包含两个主要功能：
1. **数据采集系统** - 每天自动采集股票tick数据
2. **实时量化分析** - 开市时间实时分析股票走势

## ✨ 功能特性

- 🔥 **热门股票筛选**: 自动获取当日最热的沪深主板非ST A股
- 💾 **热门股票缓存**: 每日仅获取一次热门股票，减少API调用，提升运行速度
- 💰 **筹码分布筛选**: 自动筛选获利盘少、筹码集中的股票（避免高位追涨）
- 📊 **Tick数据分析**: 获取实时分时数据进行分析
- 🎯 **主力拆单识别**: 智能识别大单拆单行为
- 📈 **走势预测**: 基于多因子模型计算上涨概率得分
- 📉 **可视化分析**: 绘制分时图并标注拆单点
- 📱 **钉钉通知**: 自动发送分析结果到钉钉群
- 🛠️ **一体化管理**: 所有功能集成在一个脚本中

## 🚀 快速开始

### 1. 环境准备
```bash
# 进入项目目录
cd /Users/bytedance/Desktop/tick_analysis

# 安装依赖
pip3 install akshare pandas numpy
# 或者使用requirements.txt
pip install -r requirements.txt
```

### 2. 量化分析系统

#### 默认分析热门股票（循环执行）
```bash
# 循环分析当日热门股票（开市时间内持续执行）
python3 start_analysis.py

# 强制循环执行（忽略开市时间限制）
python3 start_analysis.py --force

# 或直接运行分析脚本（单次执行）
python3 "quant_analysis copy.py"
```

#### 单只股票分析（单次执行）
```bash
# 分析指定股票（单次执行，自动添加到热门股票池）
python3 start_analysis.py --code 002251
python3 start_analysis.py --code 601360

# 或直接运行分析脚本
python3 "quant_analysis copy.py" --code 000001
```

#### 删除自定义股票
```bash
# 删除指定股票（从自定义股票池中移除）
python3 start_analysis.py --delete 002251
python3 start_analysis.py --delete 601360
```

#### 命令行参数
```bash
# 查看帮助
python3 start_analysis.py --help
python3 "quant_analysis copy.py" --help

# 参数说明
--code, -c      分析指定股票代码 (例如: --code 000001)
--delete, -d    删除指定股票代码 (例如: --delete 002251)
--force, -f     强制循环执行，忽略开市时间限制
--refresh, -r   强制刷新热门股票缓存（重新调用API获取最新热门股票）
```

#### 执行模式说明
- **start_analysis.py** (无参数): 循环执行模式，开市时间内持续分析热门股票
- **start_analysis.py --force**: 强制循环执行模式，忽略开市时间限制，24小时持续分析
- **start_analysis.py --code**: 单次执行模式，分析指定股票后自动添加到热门股票池
- **quant_analysis copy.py**: 单次执行模式，运行一次后退出

#### 热门股票缓存机制
为了提升运行速度和减少API调用，系统实现了热门股票缓存功能：

- 📦 **自动缓存**: 首次获取热门股票后，自动保存到 `hot_stocks_cache.json`
- 🕐 **每日更新**: 缓存以日期为单位，每个开市日仅获取一次热门股票
- ⚡ **快速启动**: 后续分析直接从缓存读取，秒级启动，无需等待API响应
- 🔄 **自动刷新**: 次日自动失效，重新获取最新热门股票
- 📋 **缓存内容**: 仅缓存热门股票（不含自定义股票），包含代码、名称、价格、涨跌幅
- 🔃 **强制刷新**: 使用 `--refresh` 参数可以强制重新获取热门股票

**强制刷新缓存示例**：
```bash
# 单次分析并强制刷新热门股票
python3 "quant_analysis copy.py" --refresh

# 循环执行并强制刷新热门股票
python3 start_analysis.py --refresh

# 组合使用：强制执行 + 强制刷新
python3 start_analysis.py --force --refresh
```

**注意**: 自定义股票（通过 `--code` 添加的股票）不会被缓存，每次分析都会重新加载。

#### 筹码分布筛选机制
为了避免高位追涨和识别主力控盘股，系统实现了筹码分布筛选功能：

- 💰 **自动筛选**: 在热门股票基础上，自动筛选获利盘少、筹码集中的股票
- 📊 **数据来源**: 使用东方财富网筹码分布数据（CYQ）
- 🕐 **每日缓存**: 筹码数据按日缓存，减少API调用，提升运行速度
- 🔍 **筛选条件**: 
  - 获利比例 < 70%（避免卖压过大）
  - 90%集中度 < 0.12（筹码不能太分散）
- 🎯 **核心价值**:
  - 避免高位追涨（获利盘过多的股票易回调）
  - 识别主力控盘股（筹码集中的股票）
  - 找到支撑位置（基于成本区间）

**筹码分布数据说明**：
```
• 获利比例: 当前价格下的获利盘比例（0-100%）
  - < 30%: 卖压小，易上涨 ✅
  - 30-70%: 中等卖压 ⚠️
  - > 70%: 卖压大，易回调 ❌

• 90%集中度: 90%筹码的集中程度
  - < 0.05: 高度集中（主力控盘）✅
  - 0.05-0.10: 中度集中 ✅
  - 0.10-0.12: 适度集中 ⚠️
  - > 0.12: 筹码分散（筛选掉）❌

• 平均成本: 市场平均持仓成本
  - 当前价格 > 平均成本: 趋势向上 ✅
  - 当前价格 ≈ 平均成本: 平衡位置 ⚠️
  - 当前价格 < 平均成本: 超跌，支撑强 ⚠️
```

**筛选流程**：
```
热门股票源（量价齐升≥2天）
  ↓
市值筛选（流通市值 ≤ 600亿）
  ↓
减持筛选（排除近3个月高频减持）
  ↓
筹码分布筛选（获利比例 < 70% 且 集中度 < 0.12）⭐ 新增
  ↓
最终股票池
```

**缓存文件**：
- 热门股票缓存: `hot_stocks_cache.json`
- 减持数据缓存: `stock_reduce_cache.json`
- 筹码分布缓存: `stock_cyq_cache.json` ⭐ 新增

### 3. 数据采集系统

#### 首次使用
```bash
# 1. 测试系统功能
./tick_system.sh --test

# 2. 手动运行一次采集
./tick_system.sh --collect

# 3. 查看采集结果
./tick_system.sh --data

# 4. 设置定时任务（每天15:30自动采集）
./tick_system.sh --setup-cron
```

#### 日常使用
```bash
# 查看数据统计
./tick_system.sh --data

# 查看具体股票数据
./tick_system.sh --view

# 查看系统日志
./tick_system.sh --logs

# 分析数据质量
./tick_system.sh --analyze
```

### 3. 实时量化分析

#### 开市时间运行
```bash
# 启动调度器（推荐）
python3 scheduler.py

# 或使用启动脚本
./start_scheduler.sh
```

#### 手动运行单次分析
```bash
python3 "quant_analysis copy.py"
```

## 📋 功能列表

### 数据采集系统 (`./tick_system.sh`)

| 命令 | 功能 | 说明 |
|------|------|------|
| `./tick_system.sh` | 交互菜单 | 显示所有选项的菜单 |
| `--collect` | 手动采集 | 立即运行一次数据采集 |
| `--data` | 查看数据 | 显示已采集的数据统计 |
| `--logs` | 查看日志 | 显示采集日志 |
| `--view` | 查看股票 | 查看具体股票的数据 |
| `--setup-cron` | 设置定时 | 设置每天15:30自动采集 |
| `--remove-cron` | 删除定时 | 删除定时任务 |
| `--analyze` | 数据分析 | 分析数据质量 |
| `--cleanup` | 清理数据 | 删除旧数据文件 |
| `--test` | 测试功能 | 测试采集器是否正常 |

### 数据查看工具 (`python3 view_data.py`)

| 命令 | 功能 | 说明 |
|------|------|------|
| `--list` | 列出文件 | 显示所有数据文件 |
| `--view 000001` | 查看股票 | 查看具体股票数据 |
| `--analyze` | 质量分析 | 分析数据质量 |
| `--search 平安` | 搜索股票 | 根据名称搜索股票 |

## 🔄 详细使用流程

### 首次使用
```bash
# 1. 进入项目目录
cd /Users/bytedance/Desktop/tick_analysis

# 2. 运行交互菜单
./tick_system.sh

# 3. 按菜单选择操作：
#    选择 "1" - 测试采集器功能
#    选择 "2" - 手动运行一次采集
#    选择 "6" - 设置定时任务（每天15:30执行）
```

### 日常使用
```bash
# 查看数据统计
./tick_system.sh --data

# 查看采集日志
./tick_system.sh --logs

# 查看具体股票数据
./tick_system.sh --view

# 分析数据质量
./tick_system.sh --analyze
```

### 自动化使用
```bash
# 设置定时任务（一次性操作）
./tick_system.sh --setup-cron

# 设置完成后，系统每天15:30自动采集
# 无需人工干预
```

## 📊 数据管理

### 数据采集过程说明
当您运行采集脚本时，系统会：

1. **自动筛选股票** - 找到5-30元之间的沪深主板非ST股票
2. **批量采集数据** - 逐个获取每只股票的tick数据
3. **保存到CSV** - 每只股票保存为单独的CSV文件
4. **生成报告** - 显示采集结果统计

### 数据文件说明
- **存储位置**: `tick_data/` 目录
- **文件格式**: `股票代码_日期_tick.csv`
- **数据内容**: 时间、价格、成交量、买卖盘性质等
- **更新频率**: 每天收盘后自动更新

### 查看tick数据
```bash
# 列出所有数据文件
python3 view_data.py --list

# 查看具体股票数据
python3 view_data.py --view 000001 --rows 10

# 分析数据质量
python3 view_data.py --analyze

# 搜索股票
python3 view_data.py --search 平安
```

## 🧠 核心算法

### 主力拆单识别算法

1. **大单阈值计算**: 使用成交额的95分位数作为大单判断标准
2. **时间窗口分析**: 5分钟滑动窗口检测连续大单
3. **拆单特征识别**: 
   - 连续出现多笔大单
   - 成交额超过阈值
   - 时间集中性分析

### 评分模型

综合四个维度计算股票上涨概率得分：

- **价格动量** (30%): 基于价格变化趋势
- **成交量** (25%): 成交量放大程度
- **拆单强度** (25%): 主力资金流入流出情况
- **价格稳定性** (20%): 价格波动性分析

## 📈 分时图说明

- 🔴 **红色点**: 主力买入拆单
- 🟢 **绿色点**: 主力卖出拆单
- **点的大小**: 表示拆单强度
- **颜色深度**: 强度越大，颜色越深

## 🔧 系统维护

### 查看日志
```bash
# 查看系统日志
./tick_system.sh --logs

# 查看实时分析日志（如果在前台运行）
# 日志会直接显示在终端
```

### 清理数据
```bash
# 清理旧数据文件
./tick_system.sh --cleanup
```

### 停止服务
```bash
# 停止实时分析（如果在前台运行）
# 按 Ctrl+C

# 停止后台进程
ps aux | grep python
kill <进程ID>
```

## ⚙️ 配置说明

### 数据采集配置
- **股票筛选**: 沪深主板非ST股票，股价5-30元
- **采集时间**: 每天15:30自动执行
- **数据精度**: 3秒级别tick数据
- **接口**: 使用 `stock_sh_a_spot_em` 和 `stock_sz_a_spot_em`

### 量化分析配置
- **运行时间**: 开市时间（9:30-15:00）
- **执行频率**: 每轮完成后立即开始下一轮
- **超时时间**: 10分钟

## 🆘 故障排除

### 常见问题

1. **权限错误**
   ```bash
   chmod +x tick_system.sh
   ```

2. **依赖缺失**
   ```bash
   pip3 install akshare pandas numpy
   ```

3. **网络问题**
   - 系统有重试机制和备用方案
   - 检查网络连接

4. **数据问题**
   ```bash
   # 重新测试
   ./tick_system.sh --test
   
   # 查看数据质量
   ./tick_system.sh --analyze
   ```

### 调试模式
```bash
# 启用详细输出
python3 -u tick_data_collector.py

# 查看详细日志
./tick_system.sh --logs
```

## 📋 常用命令速查

| 功能 | 命令 | 说明 |
|------|------|------|
| 数据采集 | `./tick_system.sh --collect` | 立即采集数据 |
| 查看数据 | `./tick_system.sh --data` | 查看数据统计 |
| 设置定时 | `./tick_system.sh --setup-cron` | 设置自动采集 |
| 测试功能 | `./tick_system.sh --test` | 测试系统功能 |
| 查看日志 | `./tick_system.sh --logs` | 查看系统日志 |
| 实时分析 | `python3 scheduler.py` | 启动实时分析 |
| 数据查看 | `python3 view_data.py --list` | 列出数据文件 |

## ⚠️ 注意事项

1. 本系统仅供学习和研究使用
2. 投资有风险，决策需谨慎
3. 建议结合其他分析方法综合判断
4. 数据来源于AKShare，可能存在延迟
5. 确保网络连接稳定
6. 数据文件会占用存储空间
7. 建议定期清理旧数据

## 🏗️ 技术架构

- **数据源**: AKShare
- **分析语言**: Python
- **可视化**: Matplotlib
- **通知**: 钉钉Webhook
- **算法**: 多因子量化模型
- **管理**: 一体化Shell脚本

## 📝 更新日志

- v1.0: 初始版本，实现基础分析功能
  - 支持热门股票筛选
  - 支持主力拆单识别
  - 支持分时图可视化
  - 支持钉钉消息推送
- v1.1: 添加数据采集系统
- v1.2: 一体化管理脚本
- v1.3: 优化网络接口和容错机制

## 🎉 总结

- **数据采集**: 使用 `./tick_system.sh` 管理
- **实时分析**: 使用 `python3 scheduler.py` 启动
- **数据查看**: 使用 `python3 view_data.py` 查看
- **所有功能**: 都有详细的帮助信息，使用 `--help` 查看

现在您只需要记住一个命令：`./tick_system.sh`

所有功能都在这一个文件里，使用简单，功能完整！