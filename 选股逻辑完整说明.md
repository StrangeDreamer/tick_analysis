# 📊 选股逻辑完整说明

> **核心理念**: 量价齐升趋势 + 多层风控筛选 + 实时资金流向分析

---

## 🎯 一、整体策略定位

### 策略类型
- **趋势跟踪策略**: 捕捉中短期上涨趋势
- **持仓周期**: 3-7天（波段交易）
- **风险偏好**: 中等风险，注重风控

### 核心逻辑
```
量价齐升股票（趋势初现）
  ↓
多层筛选（排除风险）
  ↓
Tick数据分析（验证资金流向）
  ↓
评分排序（优中选优）
  ↓
推荐前50只（最优标的）
```

---

## 📈 二、9步筛选流程详解

### 第1步：热门股票源 🔥

**数据来源**: `ak.stock_rank_ljqs_ths()`（同花顺量价齐升排行）

**为什么选这个接口？**
- ✅ 量价齐升 = 趋势初现的强势信号
- ✅ 同花顺数据质量高，更新及时
- ✅ 已经过一轮市场验证

**获取数据**:
```python
量价齐升天数   # 连续几天量价同步上涨
最新价        # 当前股价
阶段涨幅      # 累计涨幅
股票简称      # 股票名称
```

**初步池**: 通常200-500只股票

---

### 第2步：基础筛选 📋

**目的**: 排除不符合策略的股票

#### 筛选条件详解

| 条件 | 阈值 | 原因 |
|------|------|------|
| **量价齐升天数** | ≥ 2天 | 趋势确认，至少2天才算初步成型 |
| **沪深主板** | SH600/601/603/605<br>SZ000/001/002 | 排除创业板(300)和科创板(688)，降低波动 |
| **非ST股票** | 股票名称不含"ST" | ST股票风险大，退市风险高 |
| **价格区间** | 5元 ~ 30元 | 排除垃圾股(<5元)和高价股(>30元) |
| **阶段涨幅** | ≤ 9.8% | 避免追高，排除即将涨停的股票 |

**关键理由**:
1. **量价齐升≥2天**: 
   - 1天可能是偶然
   - 2天表示趋势初现
   - 太多天(≥5天)可能已涨太高

2. **主板优先**:
   - 创业板(300)波动大，风险高
   - 科创板(688)门槛高，散户不友好
   - 主板相对稳定

3. **5-30元**:
   - <5元: 垃圾股、ST股居多
   - >30元: 股价基数高，上涨空间有限
   - 5-30元: 活跃度好，上涨空间合理

4. **涨幅≤9.8%**:
   - 避免涨停板附近追高
   - 预留上涨空间
   - 降低买入后回调风险

**筛选后**: 约50-150只股票

---

### 第3步：市值筛选 💰

**数据来源**: `ak.stock_individual_spot_xq()`（雪球个股实时信息）

**筛选条件**: 流通市值 ≤ 600亿

**为什么要市值筛选？**
1. **大盘股（>600亿）**:
   - ❌ 盘子大，拉升困难
   - ❌ 上涨空间有限
   - ❌ 需要巨量资金推动
   - 例如：贵州茅台（2万亿）、工商银行（2万亿）

2. **中小盘股（≤600亿）**:
   - ✅ 盘子小，易拉升
   - ✅ 上涨空间大
   - ✅ 资金效率高
   - 例如：次新股、题材股

**执行方式**: 10线程并发，快速筛选

**筛选后**: 约30-80只股票

---

### 第4步：减持筛选 ⚠️

**数据来源**: `ak.stock_ggcg_em(symbol="股东减持")`（东方财富高管股份变动）

**筛选条件**: 排除近3个月高频减持（≥3次）的股票

**为什么要排除减持股？**
1. **高频减持 = 危险信号**:
   - ❌ 内部人最了解公司
   - ❌ 减持说明不看好后市
   - ❌ 抛压增加，股价承压

2. **3次是什么概念？**:
   - 1次: 可能是个人资金需求
   - 2次: 开始可疑
   - **≥3次**: 明确的撤离信号 ⚠️

**缓存机制**: 
- 每日只获取一次，缓存到 `stock_reduce_cache.json`
- 避免频繁API调用
- 提升运行速度

**筛选后**: 约20-60只股票

---

### 第5步：筹码分布筛选 💎

**数据来源**: `ak.stock_cyq_em()`（东方财富筹码分布）

**筛选条件**:
1. 获利比例 < 70%
2. 90%集中度 < 0.12

#### 5.1 获利比例筛选

**含义**: 当前价格下的获利盘比例

**为什么要 < 70%？**

| 获利比例 | 含义 | 风险 |
|---------|------|------|
| < 30% | 大部分套牢，卖压小 | ✅ 低风险 |
| 30-70% | 部分获利，中等卖压 | ⚠️ 中等风险 |
| **> 70%** | 大量获利，卖压大 | ❌ 高风险（筛选掉）|

**实际案例**:
```
股票A: 获利比例 32% → ✅ 通过（卖压小）
股票B: 获利比例 58% → ✅ 通过（中等）
股票C: 获利比例 75% → ❌ 排除（卖压大，易回调）
```

#### 5.2 筹码集中度筛选

**含义**: 90%的筹码分布在多大的价格区间内

**计算公式**:
```
90%集中度 = (90%成本上限 - 90%成本下限) / 平均成本
```

**为什么要 < 0.12？**

| 集中度 | 含义 | 评级 |
|--------|------|------|
| < 0.05 | 高度集中（主力控盘） | ✅ 极好 |
| 0.05-0.10 | 中度集中 | ✅ 好 |
| 0.10-0.12 | 适度集中 | ⚠️ 一般 |
| **> 0.12** | 筹码分散 | ❌ 差（筛选掉）|

**实际案例**:
```
股票A: 集中度 0.071 → ✅ 通过（主力明显）
股票B: 集中度 0.110 → ✅ 通过（适度集中）
股票C: 集中度 0.125 → ❌ 排除（太分散）
```

**为什么筹码集中好？**
1. 主力控盘明显
2. 散户少，易拉升
3. 筹码锁定，抛压小
4. 上涨空间大

**缓存机制**: 
- 每日缓存到 `stock_cyq_cache.json`
- 10线程并发获取
- 大幅提升速度

**筛选后**: 约10-30只股票

---

### 第6步：Tick数据获取 📊

**数据来源**: `ak.stock_zh_a_tick_tx_js()`（腾讯3秒级tick数据）

**获取内容**:
```
成交时间    # 精确到秒
成交价格    # 每笔交易价格
价格变动    # 相对上笔的价格变化
成交量      # 每笔交易手数
成交金额    # 每笔交易金额
买卖盘性质  # 主动买入/主动卖出
```

**为什么需要Tick数据？**
1. **高频数据**: 3秒级，捕捉实时资金流向
2. **精确判断**: 每笔交易的买卖性质
3. **验证趋势**: 量价齐升是否有资金支撑

**数据处理**:
```python
# 1. 计算价变权重（w1）
w1 = tanh(|价格变动| / 0.01) × sign(价格变动)

# 2. 计算量权重（w2）
w2 = min(1, 成交量 / (3 × 平均量))

# 3. 计算方向强度（prob）
prob = EWM(w1 × w2)  # 指数加权移动平均

# 4. 计算资金流向（mf）
mf = prob × 成交额
  - mf > 0: 主动买入
  - mf < 0: 主动卖出

# 5. 重新分类买卖盘
买卖盘性质 = "买盘" if mf > 0 else "卖盘"
```

**过滤规则**: 
- 过滤掉成交量=0的记录（无效数据）

**执行方式**: 10线程并发，批量获取

**获取后**: 每只股票约500-2000条tick记录

---

### 第7步：交易方向分析 🧮

**目的**: 分析主力资金的真实意图

#### 7.1 核心指标

| 指标 | 计算方式 | 含义 |
|------|---------|------|
| **买盘比例** | 买盘次数 / 总交易次数 | 买盘交易占比 |
| **卖盘比例** | 卖盘次数 / 总交易次数 | 卖盘交易占比 |
| **买盘成交量** | Σ买盘成交量 | 买盘总手数 |
| **卖盘成交量** | Σ卖盘成交量 | 卖盘总手数 |
| **净买入量** ⭐ | 买盘量 - 卖盘量 | 资金净流入 |
| **主动买入强度** ⭐⭐⭐⭐⭐ | 买盘量 / (买盘量+卖盘量) | 买方力量占比 |
| **主动卖出强度** | 卖盘量 / (买盘量+卖盘量) | 卖方力量占比 |

#### 7.2 主动买入强度详解

**为什么它最重要？**
1. **直接反映资金意图**:
   - > 50%: 买方力量占优
   - = 50%: 买卖平衡
   - < 50%: 卖方力量占优

2. **基于成交量，不是次数**:
   - 不是看交易次数
   - 而是看资金量
   - 大单比小单更重要

**实际案例**:
```
股票A: 主动买入强度 68.2%
  → 买方力量明显占优
  → 主力在积极吸筹
  → ✅ 好信号

股票B: 主动买入强度 42.3%
  → 卖方力量占优
  → 主力在撤离
  → ❌ 坏信号
```

---

### 第8步：评分计算 🎯

**目的**: 量化评估股票的上涨概率

#### 8.1 评分公式

```python
总得分 = 主动买卖强度得分 × 70% + 净买入量得分 × 30%
```

#### 8.2 主动买卖强度得分（70%权重）⭐⭐⭐⭐⭐

**计算步骤**:
```python
# 1. 计算强度差
buy_sell_score = (active_buy_ratio - active_sell_ratio) × 70

# 2. 限制范围
buy_sell_score = min(max(buy_sell_score, -50), 50)

# 3. 应用权重
主动买卖强度得分 = buy_sell_score × 0.70
```

**得分范围**: -35 ~ +35

**含义**:
- **+35**: 主动买入100%，卖出0%（理想）
- **+17.5**: 主动买入75%，卖出25%（很好）
- **0**: 买卖各50%（中性）
- **-17.5**: 主动买入25%，卖出75%（很差）
- **-35**: 主动买入0%，卖出100%（最差）

**为什么权重70%？**
- 最核心的指标
- 直接反映主力资金意图
- 其他指标只是辅助

#### 8.3 净买入量得分（30%权重）⭐⭐⭐

**计算步骤**:
```python
# 1. 计算净买入量
net_buy_volume = 买盘成交量 - 卖盘成交量

# 2. 归一化
avg_volume = 平均成交量
net_buy_score = net_buy_volume / (avg_volume × 10)

# 3. 限制范围
net_buy_score = min(max(net_buy_score, -15), 15)

# 4. 应用权重
净买入量得分 = net_buy_score × 0.30
```

**得分范围**: -4.5 ~ +4.5

**含义**:
- **+4.5**: 净买入是平均量的15倍（超强）
- **+2.25**: 净买入是平均量的7.5倍（强）
- **0**: 买卖平衡
- **-2.25**: 净卖出是平均量的7.5倍（弱）
- **-4.5**: 净卖出是平均量的15倍（超弱）

**为什么权重30%？**
- 辅助验证指标
- 防止单一指标误判
- 平衡质量和数量

#### 8.4 总得分解读

| 得分区间 | 评级 | 含义 |
|---------|------|------|
| > 20 | ⭐⭐⭐⭐⭐ | 极强，主力明显进场 |
| 10-20 | ⭐⭐⭐⭐ | 强势，有明显买盘 |
| 5-10 | ⭐⭐⭐ | 较强，有一定买盘 |
| 0-5 | ⭐⭐ | 中性偏强，观察 |
| < 0 | ⭐ | 弱势，卖盘占优 |

**实际案例**:
```
股票A（步步高 SZ002251）:
  主动买入强度: 68.2%
  主动卖出强度: 31.8%
  净买入量: +125,000手
  
  计算:
    主动买卖得分 = (0.682 - 0.318) × 70 × 0.70 = 17.84
    净买入量得分 = 125000/(5000×10) × 0.30 = 0.75
    总得分 = 17.84 + 0.75 = 18.59
  
  评级: ⭐⭐⭐⭐ 强势股票，建议关注
```

**执行方式**: 10线程并发，批量计算

---

### 第9步：最终筛选 ✅

**目的**: 最后一道关，确保推荐质量

#### 9.1 筛选条件

1. **主动买入强度 < 100%**:
   - 排除涨停板（买入强度100%）
   - 排除数据异常股票
   - 保证数据真实性

2. **涨跌幅 ≤ 9.8%**（钉钉发送前再次检查）:
   - 实时涨跌幅可能已超过筛选时的阈值
   - 最后一次确认，避免追高
   - 确保推荐的都是可买入的

#### 9.2 排序和推荐

**排序规则**: 按总得分从高到低

**推荐数量**: 前50只

**为什么是50只？**
1. 过多: 信息过载，无法关注
2. 过少: 选择余地小，风险集中
3. 50只: 平衡了数量和质量

**最终输出**: 
- 钉钉消息: 前50只
- 包含信息: 代码、名称、得分、涨跌幅、股价、市值、买卖比例

---

## 🎯 三、完整案例演示

### 案例：步步高（SZ002251）

#### 筛选过程

**第1步：热门股票源**
```
✅ 来自量价齐升排行榜
   量价齐升天数: 3天
   最新价: 8.20元
   阶段涨幅: 3.2%
```

**第2步：基础筛选**
```
✅ 量价齐升 3天 >= 2天
✅ 沪深主板 SZ002（深圳主板）
✅ 非ST股票
✅ 价格 8.20元 在 5-30元区间
✅ 涨幅 3.2% <= 9.8%
```

**第3步：市值筛选**
```
✅ 流通市值: 45.6亿 <= 600亿
```

**第4步：减持筛选**
```
✅ 近3个月减持次数: 0次 < 3次
```

**第5步：筹码分布筛选**
```
✅ 获利比例: 32.8% < 70%
✅ 90%集中度: 0.065 < 0.12
```

**第6步：Tick数据获取**
```
✅ 获取到 1,234条 tick记录
```

**第7步：交易方向分析**
```
买盘比例: 62.5%
卖盘比例: 37.5%
买盘成交量: 850,000手
卖盘成交量: 725,000手
净买入量: +125,000手
主动买入强度: 68.2% ✅
主动卖出强度: 31.8%
```

**第8步：评分计算**
```
主动买卖得分: (0.682-0.318)×70×0.70 = 17.84
净买入量得分: 125000/(5000×10)×0.30 = 0.75
总得分: 17.84 + 0.75 = 18.59 ⭐⭐⭐⭐
```

**第9步：最终筛选**
```
✅ 主动买入强度 68.2% < 100%
✅ 涨跌幅 3.2% <= 9.8%
✅ 进入推荐列表（排名第3）
```

#### 推荐结果

```markdown
3. SZ002251 步步高
   • 得分: 18.59 ⭐⭐⭐⭐
   • 股价: 8.20元
   • 流通市值: 45.6亿
   • 涨跌幅: 3.20%
   • 买盘比例: 62.5%
   • 卖盘比例: 37.5%
   • 净买入量: 125,000
   • 主动买入强度: 68.2%
   
   💡 分析: 主力资金明显进场，量价齐升趋势确立，建议关注！
```

---

## 📊 四、核心优势

### 1. 多层筛选，风险可控 ⭐⭐⭐⭐⭐

```
原始池: 500只
  ↓ 基础筛选（量价齐升、主板、价格）
中级池: 150只 （筛除 70%）
  ↓ 市值筛选（≤600亿）
小级池: 80只 （再筛除 47%）
  ↓ 减持筛选（排除高频减持）
更小池: 60只 （再筛除 25%）
  ↓ 筹码筛选（获利<70%、集中度<0.12）
最终池: 30只 （再筛除 50%）
  ↓ Tick分析+评分排序
推荐池: 前50只
```

**风控点**:
- ❌ 排除高风险股票（ST、创业板、科创板）
- ❌ 排除追高风险（涨幅>9.8%）
- ❌ 排除大盘股（流通市值>600亿）
- ❌ 排除减持股（高频减持）
- ❌ 排除高位股（获利比例>70%）
- ❌ 排除分散股（集中度>0.12）

### 2. 实时数据，精准判断 ⭐⭐⭐⭐⭐

**数据精度**:
- 3秒级tick数据（不是日线、分钟线）
- 实时资金流向（不是历史数据）
- 每笔交易分析（不是成交总量）

**判断精准**:
- 主动买卖强度（主力意图明确）
- 净买入量（资金流向清晰）
- 买卖盘比例（力量对比直观）

### 3. 量化评分，客观排序 ⭐⭐⭐⭐⭐

**避免主观**:
- 不靠感觉
- 不靠新闻
- 不靠传闻

**量化指标**:
- 70% 主动买卖强度
- 30% 净买入量
- 综合评分，客观排序

### 4. 批量并发，效率极高 ⭐⭐⭐⭐⭐

**10线程并发处理**:
- 市值筛选: 10线程
- 筹码筛选: 10线程
- Tick获取: 10线程
- 交易分析: 10线程
- 实时信息: 10线程

**速度提升**: 约10倍 ⚡

**处理能力**: 100只股票仅需约17秒

### 5. 缓存机制，稳定高效 ⭐⭐⭐⭐

**三大缓存**:
1. `hot_stocks_cache.json`: 热门股票（每日缓存）
2. `stock_reduce_cache.json`: 减持数据（每日缓存）
3. `stock_cyq_cache.json`: 筹码分布（每日缓存）

**优势**:
- 减少API调用
- 提升运行速度
- 降低被限流风险
- 数据每日自动刷新

---

## 🎯 五、使用建议

### 1. 什么时候用？

**最佳时机**:
- ✅ 开盘后1小时（9:30-10:30）
- ✅ 午盘前（11:00-11:30）
- ✅ 尾盘前（14:00-14:30）

**不建议时机**:
- ❌ 开盘前（数据不足）
- ❌ 收盘后（无法买入）
- ❌ 非交易日（数据失效）

### 2. 如何使用推荐结果？

**Top 10**:
- 重点关注，优先考虑
- 得分高，资金流入明显
- 建议深入研究

**Top 11-30**:
- 备选关注，可以考虑
- 得分中等，有一定机会
- 根据个人判断

**Top 31-50**:
- 了解即可，不强制
- 得分一般，机会不大
- 可以忽略

### 3. 如何结合其他因素？

**技术面**:
- 查看K线形态（是否在低位？）
- 查看成交量（是否放量？）
- 查看均线（是否多头排列？）

**基本面**:
- 查看行业趋势（是否景气？）
- 查看公司质量（是否优质？）
- 查看财务数据（是否健康？）

**消息面**:
- 是否有利好消息？
- 是否有政策支持？
- 是否有资金关注？

### 4. 风险提示 ⚠️

**系统风险**:
- 本系统基于历史数据和技术分析
- 无法预测突发事件（黑天鹅）
- 无法保证100%准确

**市场风险**:
- 股市有风险，投资需谨慎
- 过去表现不代表未来
- 务必做好止损

**使用建议**:
- 不要all-in单只股票
- 建议分散投资（5-10只）
- 设置止损位（-5%到-10%）
- 设置止盈位（+10%到+20%）

---

## 📚 六、相关文档

| 文档 | 说明 |
|------|------|
| `README.md` | 系统总览和使用指南 |
| `股票筛选和算分逻辑.md` | 详细的技术实现 |
| `筹码分布功能说明.md` | 筹码分布详解 |
| `70vs90集中度对比分析.md` | 集中度选择分析 |
| `筹码分布快速参考.txt` | 快速参考卡片 |

---

## 🚀 七、快速上手

```bash
# 1. 直接运行（循环执行）
python3 start_analysis.py

# 2. 单次分析
python3 "quant_analysis copy.py"

# 3. 分析指定股票
python3 start_analysis.py --code 002251

# 4. 强制刷新缓存
python3 start_analysis.py --refresh

# 5. 只分析自定义股票
python3 start_analysis.py --custom-only

# 6. 查看自定义股票池
python3 start_analysis.py --list

# 7. 删除自定义股票
python3 start_analysis.py --delete 002251
```

---

**最后更新**: 2025-10-27  
**版本**: v3.0  
**作者**: Tick Analysis System

---

**免责声明**: 本系统仅供学习和研究使用，不构成任何投资建议。股市有风险，投资需谨慎。

