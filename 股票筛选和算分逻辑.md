# 股票筛选和算分逻辑详解

## 📋 目录
1. [股票筛选流程](#股票筛选流程)
2. [评分算法](#评分算法)
3. [关键指标说明](#关键指标说明)

---

## 🔄 股票筛选流程

### 完整流程图

```
┌─────────────────────────────────────────────────────────────┐
│                   第1步：热门股票源                          │
│            ak.stock_rank_ljqs_ths()                         │
│                 量价齐升排行（同花顺）                       │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                   第2步：基础筛选                            │
│  ✓ 量价齐升天数 >= 2天                                      │
│  ✓ 沪深主板 (SH600/601/603/605, SZ000/001/002)            │
│  ✓ 非ST股票                                                 │
│  ✓ 价格: 5元 ~ 30元                                        │
│  ✓ 阶段涨幅 <= 9.8%                                        │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                 第3步：市值筛选（10线程）                    │
│    ak.stock_individual_spot_xq()                            │
│    ✓ 流通市值 <= 600亿                                      │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│               第4步：减持筛选（每日缓存）                     │
│    ak.stock_ggcg_em(symbol="股东减持")                      │
│    ✓ 排除近3个月高频减持股票                                │
│    ✓ 高频定义: 减持次数 >= 3次                              │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│             第5步：筹码分布筛选（10线程，每日缓存）           │
│    ak.stock_cyq_em(symbol=code, adjust="hfq")              │
│    ✓ 获利比例 < 70% (避免卖压过大)                         │
│    ✓ 90%集中度 < 0.12 (筹码不能太分散)                     │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                     最终股票池                               │
│               准备进行Tick数据分析                           │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│               第6步：Tick数据获取（10线程）                  │
│    ak.stock_zh_a_tick_tx_js(symbol=code)                   │
│    ✓ 获取3秒级tick数据                                      │
│    ✓ 过滤掉成交量=0的记录                                   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                   第7步：交易方向分析                        │
│    analyze_trade_direction()                                │
│    ✓ 计算买盘/卖盘比例                                      │
│    ✓ 计算净买入量                                           │
│    ✓ 计算主动买卖强度                                       │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                     第8步：评分计算                          │
│    calculate_score()                                        │
│    ✓ 主动买卖强度得分 (70%)                                │
│    ✓ 净买入量得分 (30%)                                    │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                   第9步：最终筛选                            │
│    ✓ 主动买入强度 < 100%                                   │
│    ✓ 涨跌幅 <= 9.8% (钉钉消息发送前再次检查)               │
│    ✓ 按得分排序，取前50只发送钉钉                          │
└─────────────────────────────────────────────────────────────┘
```

---

## 📊 评分算法

### 核心公式

```python
总得分 = 主动买卖强度得分 × 70% + 净买入量得分 × 30%
```

### 1. 主动买卖强度得分（70% 权重）⭐⭐⭐⭐⭐

**计算逻辑：**
```python
# 主动买卖强度（基于成交量）
active_buy_ratio = 买盘成交量 / (买盘成交量 + 卖盘成交量)
active_sell_ratio = 卖盘成交量 / (买盘成交量 + 卖盘成交量)

# 计算强度差
buy_sell_score = (active_buy_ratio - active_sell_ratio) × 70

# 限制在-50到+50范围内
buy_sell_score = min(max(buy_sell_score, -50), 50)

# 应用权重
主动买卖强度得分 = buy_sell_score × 0.70
```

**评分范围：** -35 ~ +35  
**含义：**
- +35: 主动买入强度100%，主动卖出强度0%（理想情况）
- 0: 主动买入和卖出各占50%（中性）
- -35: 主动买入强度0%，主动卖出强度100%（最差情况）

**为什么重要：**
- 主动买入强度高 → 主力资金积极进场
- 主动卖出强度高 → 主力资金加速出逃
- 这是最核心的指标，权重占70%

### 2. 净买入量得分（30% 权重）⭐⭐⭐

**计算逻辑：**
```python
# 净买入量
net_buy_volume = 买盘成交量 - 卖盘成交量

# 平均成交量
avg_volume = tick数据['成交量'].mean()

# 计算净买入量得分
net_buy_score = net_buy_volume / (avg_volume × 10)

# 限制在-15到+15范围内
net_buy_score = min(max(net_buy_score, -15), 15)

# 应用权重
净买入量得分 = net_buy_score × 0.30
```

**评分范围：** -4.5 ~ +4.5  
**含义：**
- +4.5: 净买入量是平均成交量的15倍（超强买盘）
- 0: 净买入量为0（买卖平衡）
- -4.5: 净卖出量是平均成交量的15倍（超强卖盘）

**为什么重要：**
- 净买入量大 → 买方力量强劲
- 净买入量小/负 → 卖方力量占优
- 这是辅助指标，权重占30%

### 总得分范围

```
最高得分: +35 + 4.5 = +39.5
最低得分: -35 - 4.5 = -39.5
中性得分: 0
```

**得分解读：**
- **> 10分**: 强势股票，主力资金明显进场
- **5 ~ 10分**: 较强股票，有一定买盘支撑
- **0 ~ 5分**: 中性偏强，观察
- **< 0分**: 弱势股票，卖盘占优

---

## 🔍 关键指标说明

### Tick数据处理

#### 1. 价格变动 (dp)
```python
# 使用API直接返回的价格变动（元）
tick_df['dp'] = tick_df['价格变动']
```

#### 2. 价变权重 (w1)
```python
# 使用tanh函数归一化，并保留符号
tick_df['w1'] = np.tanh(np.abs(tick_df['dp']) / 0.01) × np.sign(tick_df['dp'])
```
**含义：** 价格变动越大，权重越接近±1

#### 3. 量权重 (w2)
```python
# 20笔滚动平均成交量
tick_df['meanV'] = tick_df['成交量'].rolling(20, min_periods=1).mean()

# 成交量权重
tick_df['w2'] = np.minimum(1, tick_df['成交量'] / (3 × tick_df['meanV']))
```
**含义：** 成交量是平均值3倍以上时，权重=1

#### 4. 方向强度 (prob)
```python
# 指数加权移动平均
alpha = 2 / 6
tick_df['prob'] = (tick_df['w1'] × tick_df['w2']).ewm(alpha=alpha, adjust=False).mean()
```
**含义：** 综合价格变动和成交量的方向强度

#### 5. 资金流向 (mf)
```python
# 资金流向（元）
tick_df['mf'] = tick_df['prob'] × tick_df['成交额']
```
**含义：** 
- mf > 0: 主动买入
- mf < 0: 主动卖出

#### 6. 买卖盘性质分类
```python
# 基于mf重新计算买卖盘性质
tick_df['买卖盘性质'] = tick_df['mf'].apply(lambda x: '卖盘' if x < 0 else '买盘')

# 重新计算成交量（手数）
tick_df['成交量'] = (np.abs(tick_df['mf']) / tick_df['成交价'] / 100).round().astype(int)

# 重新计算成交金额
tick_df['成交额'] = np.abs(tick_df['mf']).round().astype(int)

# 过滤掉成交量=0的记录
tick_df = tick_df[tick_df['成交量'] > 0]
```

---

## 📈 交易方向指标

### 1. 买盘比例 (buy_ratio)
```python
buy_ratio = 买盘次数 / 总交易次数
```
**含义：** 买盘交易在所有交易中的占比

### 2. 卖盘比例 (sell_ratio)
```python
sell_ratio = 卖盘次数 / 总交易次数
```
**含义：** 卖盘交易在所有交易中的占比

### 3. 买盘成交量 (buy_volume)
```python
buy_volume = tick_df[tick_df['买卖盘性质'] == '买盘']['成交量'].sum()
```
**含义：** 所有买盘交易的总成交量

### 4. 卖盘成交量 (sell_volume)
```python
sell_volume = tick_df[tick_df['买卖盘性质'] == '卖盘']['成交量'].sum()
```
**含义：** 所有卖盘交易的总成交量

### 5. 净买入量 (net_buy_volume) ⭐⭐⭐⭐⭐
```python
net_buy_volume = buy_volume - sell_volume
```
**含义：** 
- > 0: 买盘力量强
- = 0: 买卖平衡
- < 0: 卖盘力量强

### 6. 主动买入强度 (active_buy_ratio) ⭐⭐⭐⭐⭐
```python
active_buy_ratio = buy_volume / (buy_volume + sell_volume)
```
**含义：** 
- > 0.5: 买盘力量占优
- = 0.5: 买卖力量平衡
- < 0.5: 卖盘力量占优

**筛选条件：** active_buy_ratio < 1.0 (100%)
- 排除主动买入强度=100%的股票（可能是涨停或数据异常）

### 7. 主动卖出强度 (active_sell_ratio)
```python
active_sell_ratio = sell_volume / (buy_volume + sell_volume)
```
**含义：** 
- > 0.5: 卖盘力量占优
- = 0.5: 买卖力量平衡
- < 0.5: 买盘力量占优

---

## 💡 筛选逻辑总结

### 第1-5步：初步筛选（减少股票池）

```
原始股票池
  ↓ 基础筛选（量价齐升、主板、非ST、价格、涨幅）
中等股票池
  ↓ 市值筛选（流通市值<=600亿）
较小股票池
  ↓ 减持筛选（排除高频减持）
更小股票池
  ↓ 筹码筛选（获利盘<70%、集中度<0.12）
最终股票池（通常10-50只）
```

### 第6-9步：深度分析（计算评分）

```
最终股票池
  ↓ 获取Tick数据（3秒级高频数据）
Tick数据集
  ↓ 分析交易方向（买卖盘性质、成交量）
交易方向指标
  ↓ 计算评分（主动买卖强度70% + 净买入量30%）
股票评分
  ↓ 最终筛选（主动买入强度<100%、涨跌幅<=9.8%）
推荐股票（前50只）
```

---

## ⚖️ 权重分配说明

### 筛选阶段
- **量价齐升**: 基础条件（必须满足）
- **市值**: 重要条件（避免大盘股）
- **减持**: 重要条件（规避风险）
- **筹码**: 重要条件（避免追高）

### 评分阶段
- **主动买卖强度**: 70% 权重 ⭐⭐⭐⭐⭐
  - 最核心的指标
  - 直接反映主力资金意图
  
- **净买入量**: 30% 权重 ⭐⭐⭐
  - 辅助指标
  - 验证买卖力量对比

---

## 🎯 算法优势

1. **多层筛选**: 5步筛选确保股票质量
2. **量化评分**: 客观评价股票强弱
3. **实时数据**: 基于3秒级tick数据
4. **主力追踪**: 识别主力资金流向
5. **风险控制**: 避免追高、大盘股、减持股

---

## 📊 实际案例

### 示例1: 强势股票（得分 +25.3）

```
基本信息:
  代码: SZ002251  名称: 步步高
  价格: 8.20元    涨跌幅: +3.2%

交易方向分析:
  买盘比例: 62.5%
  卖盘比例: 37.5%
  净买入量: +125,000手
  主动买入强度: 68.2%
  主动卖出强度: 31.8%

评分计算:
  主动买卖强度得分: (0.682 - 0.318) × 70 = 25.48
  限制后: min(max(25.48, -50), 50) = 25.48
  加权: 25.48 × 0.70 = 17.84

  净买入量得分: 125000 / (平均量5000 × 10) = 2.5
  限制后: min(max(2.5, -15), 15) = 2.5
  加权: 2.5 × 0.30 = 0.75

  总得分: 17.84 + 0.75 = 18.59

结论: ✅ 强势股票，主力资金积极进场
```

### 示例2: 弱势股票（得分 -8.5）

```
基本信息:
  代码: SH600000  名称: 浦发银行
  价格: 10.50元   涨跌幅: -1.2%

交易方向分析:
  买盘比例: 38.2%
  卖盘比例: 61.8%
  净买入量: -85,000手
  主动买入强度: 42.3%
  主动卖出强度: 57.7%

评分计算:
  主动买卖强度得分: (0.423 - 0.577) × 70 = -10.78
  限制后: min(max(-10.78, -50), 50) = -10.78
  加权: -10.78 × 0.70 = -7.55

  净买入量得分: -85000 / (平均量8000 × 10) = -1.06
  限制后: min(max(-1.06, -15), 15) = -1.06
  加权: -1.06 × 0.30 = -0.32

  总得分: -7.55 + (-0.32) = -7.87

结论: ❌ 弱势股票，主力资金撤离
```

---

## 🔄 兜底机制

如果主接口 `ak.stock_rank_ljqs_ths()` 失败，系统会自动切换到兜底接口：

```
主接口失败
  ↓
ak.stock_hot_deal_xq(symbol="最热门")  # 雪球热门成交
  ↓
基础筛选（主板、非ST、价格5-30元）
  ↓
按关注度排序，取前50只
  ↓
后续流程（市值筛选、减持筛选、筹码筛选、评分）
```

---

*更新时间: 2025-10-24*
*版本: v2.0*
